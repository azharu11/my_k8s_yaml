apiVersion: v1
kind: Secret
metadata:
  name: db-credential-secret
  namespace: r8-stagging
type: Opaque
data:
  db-root-user: cm9vdA==
  db-root-password: bXlwYXNzd29yZA==
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dburl-configmap
  namespace: r8-stagging
data:
  database_url: db-service
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mycnf-configmap
  namespace: r8-stagging
data:
  my.cnf: |
    [mysqld]
    datadir=/var/lib/mysql
    socket=/var/lib/mysql/mysql.sock

    sql_mode = STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

    # Disabling symbolic-links is recommended to prevent assorted security risks
    symbolic-links=0

    log-error=/var/lib/mysql/mysqld.log
    pid-file=/var/run/mysqld/mysqld.pid

    log_bin_trust_function_creators = 1

    innodb_temp_data_file_path = ibtmp1:12M:autoextend:max:1G

    # bind-address=0.0.0.0
---
apiVersion: v1
kind: Service
metadata:
  name: db-service
  namespace: r8-stagging
spec:
  clusterIP: None
  selector:
    app: r8-database
  ports:
  -
    name: db-port
    protocol: TCP
    port: 3306
    targetPort: 3306
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: r8-database-deployment
  namespace: r8-stagging
  labels:
    app: r8-database
spec:
  serviceName: db-service
  replicas: 1
  selector:
    matchLabels:
      app: r8-database
  template:
    metadata:
      labels:
        app: r8-database
    spec:
      containers:
      -
        image: mysql:5.7
        name: r8-database-container
        ports:
        -
          name: db-port
          containerPort: 3306
        env:
        -
          name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretRefKey:
              name: db-credential-secret
              key: db-root-password
        volumeMounts:
        -
          name: mysql-config-volume
          mountPath: /etc/mysql/conf.d/my.cnf
          subPath: my.cnf
        -
          name: data
          mountPath: /var/lib/mysql
      volumes:
      -
        name: mysql-config-volume
        configMap:
          name: mycnf-configmap
volumeClaimTemplates:
  - metadata:
    name: data
  spec:
    accessModes: ["ReadWriteOnce"]
    resources:
      requests:
        storage: 10Gi
----
commit-1
----
